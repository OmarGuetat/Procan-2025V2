<div class="row g-3 align-items-end my-4">
  <!-- Client Name -->
  <div class="col-12 col-md-4">
    <label class="form-label">
      <i class="bi bi-person-fill me-1"></i> Client Name
    </label>
    <input type="text" class="form-control" placeholder="Enter client name" [(ngModel)]="clientName"
      (ngModelChange)="onFilterChange()" />
  </div>

  <!-- Start Date -->
  <div class="col-6 col-md-4">
    <label class="form-label">
      <i class="bi bi-calendar-event me-1"></i> Start Date
    </label>
    <input type="date" class="form-control" [(ngModel)]="startDate" (change)="onFilterChange()" />
  </div>

  <!-- End Date -->
  <div class="col-6 col-md-4">
    <label class="form-label">
      <i class="bi bi-calendar-check me-1"></i> End Date
    </label>
    <input type="date" class="form-control" [(ngModel)]="endDate" (change)="onFilterChange()" />
  </div>
</div>



<div class="table-responsive ">
  <table class="table table-bordered table-hover align-middle text-center">
    <thead class="table-light">
      <tr>
        <th class="text-nowrap">
          <i class="bi bi-flag me-1"></i> Status
          <span class="ms-1 text-muted" style="cursor: pointer;" (click)="onSortByPaymentStatus('False')">
            <i class="bi bi-arrow-up-short"></i>
          </span>
          <span class="ms-1 text-muted" style="cursor: pointer;" (click)="onSortByPaymentStatus('True')">
            <i class="bi bi-arrow-down-short"></i>
          </span>
        </th>
        <th class="text-nowrap"><i class="bi bi-file-earmark-text me-1"></i> Type</th>
        <th class="text-nowrap"><i class="bi bi-hash me-1"></i> Invoice Number</th>
        <th class="text-nowrap"><i class="bi bi-calendar2-check me-1"></i> Created At</th>
        <th class="text-nowrap"><i class="bi bi-person me-1"></i> Client Name</th>
        <th class="text-nowrap"><i class="bi bi-cash-stack me-1"></i> Amount Paid</th>
        <th class="text-nowrap"><i class="bi bi-file-earmark-minus me-1"></i> Unpaid Amount</th>
        <th class="text-nowrap"><i class="bi bi-gear me-1"></i> Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let item of invoices">
        <!-- Status with colored badge -->
        <td>
          <span class="badge" [ngClass]="{
                'bg-success': item.invoice.payment_status === 'paid',
                'bg-primary': item.invoice.payment_status === 'unpaid',
                'bg-warning text-dark': item.invoice.payment_status === 'partially paid'
              }">
            {{ item.invoice.payment_status }}
          </span>
        </td>

        <!-- Type -->
        <td>{{ item.invoice.type }}</td>

        <!-- Invoice Number -->
        <td>{{ item.invoice.number }}</td>

        <!-- Created At -->
        <td>{{ item.invoice.creation_date }}</td>

        <!-- Client Name -->
        <td>{{ item.client_name }}</td>

        <!-- Amount Paid -->
        <td>{{ item.invoice.amount_paid || 0 }} TND</td>

        <!-- Unpaid Amount column -->
        <td>{{ item.invoice.unpaid_amount || 0 }} TND</td>

        <!-- Actions -->
        <td class="d-flex gap-2 justify-content-center">
          <button class="btn btn-outline-warning td-btn-warning " data-bs-toggle="modal"
            data-bs-target="#updatePaymentModal" (click)="prepareUpdate(item.invoice)">
            <i class="bi bi-cash-coin"></i>
          </button>
          <!-- Go To Service Table with Icon -->
          <button class="btn btn-outline-primary td-btn" (click)="onViewAll(item.invoice.id)">
            <i class="bi bi-arrows-angle-expand"></i>
          </button>
          <!-- View History Button with Icon -->
          <button class="btn btn-outline-primary td-btn" (click)="fetchHistorique(item.invoice.id)">
            <i class="bi bi-info-circle "></i>
          </button>
          <!-- Download PDF -->
          <button class="btn btn-outline-success td-btn" (click)="downloadInvoicePdf(item.invoice.id)">
            <i class="bi bi-printer"></i>
          </button>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Pagination Controls -->
<div class="d-flex justify-content-center " *ngIf="totalPages > 1">
  <nav aria-label="Page navigation">
    <ul class="pagination">
      <li class="page-item" [class.disabled]="currentPage === 1">
        <button class="page-link" (click)="changePage(currentPage - 1)" [disabled]="currentPage === 1">
          Previous
        </button>
      </li>
      <li class="page-item" *ngFor="let page of pages" [class.active]="page === currentPage">
        <button class="page-link" (click)="changePage(page)">{{ page }}</button>
      </li>
      <li class="page-item" [class.disabled]="currentPage === totalPages">
        <button class="page-link" (click)="changePage(currentPage + 1)" [disabled]="currentPage === totalPages">
          Next
        </button>
      </li>
    </ul>
  </nav>
</div>
<!-- Update Payment Modal -->
<div class="modal fade" id="updatePaymentModal" tabindex="-1" aria-labelledby="updatePaymentModalLabel"
  aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="updatePaymentModalLabel">Update Payment - Invoice #{{ selectedInvoice?.number }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div *ngIf="selectedInvoice?.payment_status === 'unpaid'">
          <label class="form-label">Amount Paid</label>
          <input type="number" class="form-control" [(ngModel)]="updateForm.amount_paid" />
        </div>

        <div *ngIf="selectedInvoice?.payment_status === 'partially paid'">
          <label class="form-label">Amount Paid</label>
          <input type="number" class="form-control" [(ngModel)]="updateForm.amount_paid" />

          <label class="form-label mt-3">Unpaid Amount</label>
          <input type="number" class="form-control" [(ngModel)]="updateForm.unpaid_amount" />
        </div>

        <div *ngIf="selectedInvoice?.payment_status === 'paid'" class="text-muted">
          This invoice is fully paid. No updates are allowed.
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" [disabled]="selectedInvoice?.payment_status === 'paid'"
          (click)="submitUpdate()">
          Save
        </button>
      </div>

    </div>
  </div>
</div>
<!-- Historique Modal -->
<div class="modal fade" id="historiqueModal" tabindex="-1" aria-labelledby="historiqueModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="historiqueModalLabel">Invoice Historique</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div *ngIf="loadingHistorique" class="text-center">
          <i class="bi bi-arrow-clockwise fs-1"></i> Loading...
        </div>
        <div *ngIf="!loadingHistorique && historiqueData.length === 0" class="text-center">
          No historique found for this invoice.
        </div>
        <div *ngIf="!loadingHistorique && historiqueData.length > 0">
          <table class="table table-bordered table-hover">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Invoice ID</th>
                <th>Old Invoice ID</th>
                <th>Changes</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let record of historiqueData">
                <td>{{ record.id }}</td>
                <td>{{ record.invoice_id }}</td>
                <td>{{ record.old_invoice_id || '-' }}</td>
                <td>
                  <ul class="mb-0">
                    <li *ngFor="let change of record.changes | keyvalue">
                      <strong>{{ change.key }}:</strong>
                      {{ change.value }}
                    </li>
                  </ul>
                </td>
                <td>{{ record.created_at | date: 'short' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>